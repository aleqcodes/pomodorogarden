<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jard√≠n Pomodoro üçÖüå≥</title>
    <script>
        (function(){
            try {
                var t = localStorage.getItem('pomodoroTheme');
                if (t === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            } catch(e) {}
        })();
    </script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <!-- Tailwind CSS para estilos r√°pidos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animaci√≥n de crecimiento para plantas */
        @keyframes grow {
            0% { transform: scale(0) translateY(10px); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Animaci√≥n de aleteo y vuelo para mariposas */
        @keyframes flutter {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            25% { transform: translate(10px, -15px) rotate(5deg) scale(0.9); }
            50% { transform: translate(-5px, -25px) rotate(-5deg) scale(1); }
            75% { transform: translate(-15px, -10px) rotate(5deg) scale(0.95); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }

        .plant-item {
            animation: grow 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            font-size: 2.5rem;
            user-select: none;
            transition: transform 0.2s;
            cursor: pointer;
            background: rgba(240, 253, 244, 0.85);
        }

        .plant-item:hover {
            transform: scale(1.2);
        }

        .butterfly {
            position: absolute;
            font-size: 1.8rem;
            animation: flutter 3s infinite ease-in-out alternate;
            z-index: 10;
            pointer-events: none; /* Dejar pasar clicks */
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.1));
        }

        .glass-panel {
            background: rgba(240, 253, 244, 0.96);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(22, 163, 74, 0.08);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.12);
            color: #1f2937;
        }

        /* Barra de progreso circular */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        @keyframes dashSpin {
            to { stroke-dashoffset: -1000; }
        }
        .ring-dash {
            will-change: stroke-dashoffset;
            animation: dashSpin 2.2s linear infinite;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #a7f3d0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #34d399;
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #052e2b 100%);
            color: #e5e7eb;
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .dark .plant-item {
            background: rgba(255, 255, 255, 0.08);
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #374151;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        .dark #ground-gradient {
            background: linear-gradient(to top, rgba(34,197,94,0.25), transparent);
        }
    </style>
</head>
<body class="text-gray-700 relative dark:text-gray-200">

    <!-- Notificaci√≥n de sonido (invisible) -->
    <audio id="alarm-sound" preload="auto">
        <!-- Sonido suave tipo 'ding' -->
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <div class="container mx-auto px-4 py-8 flex flex-col md:flex-row gap-8 h-screen max-h-screen">
        
        <!-- Panel Izquierdo: Controles -->
        <div class="w-full md:w-1/3 flex flex-col gap-6">
            <header class="text-center md:text-left">
                <h1 id="app-title" class="text-3xl font-bold text-green-700 dark:text-green-300">üçÖ Jard√≠n Pomodoro</h1>
                <p id="app-subtitle" class="text-sm text-gray-500 dark:text-gray-400">Conc√©ntrate y cultiva tu bosque</p>
            </header>

            <div class="flex items-center justify-start gap-2">
                <button id="lang-pt" onclick="setLang('pt')" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">üáßüá∑</button>
                <button id="lang-es" onclick="setLang('es')" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">üá™üá∏</button>
                <button id="lang-en" onclick="setLang('en')" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">üá∫üá∏</button>
                <button id="theme-toggle" onclick="toggleTheme()" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">üåö Oscuro</button>
            </div>

            <div class="glass-panel rounded-3xl p-8 flex flex-col items-center justify-center relative overflow-hidden">
                <!-- Selector de Modo -->
                <div class="flex bg-gray-100 dark:bg-gray-800 rounded-full p-1 mb-8 w-full">
                    <button onclick="setMode('focus')" id="btn-focus" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-all bg-white shadow-sm text-green-600 dark:bg-gray-900 dark:text-green-400 dark:border dark:border-green-900">Enfoque</button>
                    <button onclick="setMode('short')" id="btn-short" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-all text-gray-500 hover:text-green-600 dark:text-gray-400">Corto</button>
                    <button onclick="setMode('long')" id="btn-long" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-all text-gray-500 hover:text-green-600 dark:text-gray-400">Largo</button>
                </div>

                <!-- Timer Visual -->
                <div class="relative w-64 h-64 mb-8">
                    <svg id="timer-svg" class="w-full h-full" width="250" height="250">
                        <circle class="text-gray-200 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="110" cx="128" cy="128" />
                        <circle id="spinner-ring" class="opacity-60 text-green-400 dark:text-green-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="116" cx="128" cy="128" />
                        <circle id="progress-ring" class="text-green-500 progress-ring__circle" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="110" cx="128" cy="128" />
                    </svg>
                    <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center">
                        <span id="timer-display" class="text-6xl font-bold text-gray-900 tracking-tighter dark:text-gray-100">25:00</span>
                        <span id="status-text" class="text-green-800 font-medium mt-2 dark:text-green-300">Listo para cultivar</span>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="flex gap-4 w-full">
                    <button id="toggle-btn" onclick="toggleTimer()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                        <span id="icon-play">‚ñ∂</span> <span id="text-play">Comenzar</span>
                    </button>
                    <button onclick="resetTimer()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-4 px-6 rounded-2xl shadow transform transition active:scale-95 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                        ‚Ü∫
                    </button>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="glass-panel rounded-2xl p-4 text-sm">
                <h3 id="legend-title" class="font-bold text-gray-600 mb-2 dark:text-gray-300">Tu Recompensa:</h3>
                <ul class="space-y-2">
                    <li id="legend-tree" class="flex items-center gap-2"><span class="text-xl">üçé/üçã</span> 25 min = √Årbol Frutal</li>
                    <li id="legend-flower" class="flex items-center gap-2"><span class="text-xl">üåª/üåπ</span> 5 min = Flor</li>
                    <li id="legend-butterfly" class="flex items-center gap-2"><span class="text-xl">ü¶ã</span> 15 min = Mariposa (Vuela)</li>
                </ul>
            </div>
            
            <button id="reset-btn" onclick="clearGarden()" class="text-xs text-red-400 underline hover:text-red-600 text-center mt-2">Reiniciar Jard√≠n (Borrar todo)</button>
        </div>

        <!-- Panel Derecho: El Jard√≠n -->
        <div class="w-full md:w-2/3 flex flex-col h-full relative">
            <div class="glass-panel flex-1 rounded-3xl p-6 relative overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 z-20">
                    <h2 id="garden-title" class="text-xl font-bold text-green-800 dark:text-green-300">Tu Jard√≠n</h2>
                    <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-bold dark:bg-green-900 dark:text-green-200">
                        <span id="plant-label">Plantas</span>: <span id="plant-count">0</span> | <span id="butterfly-label">Mariposas</span>: <span id="butterfly-count">0</span>
                    </span>
                </div>

                <!-- √Årea del cielo (Para mariposas) -->
                <div id="sky-layer" class="absolute inset-0 z-10 pointer-events-none overflow-hidden">
                    <!-- Las mariposas se inyectar√°n aqu√≠ -->
                </div>

                <!-- √Årea del suelo (Para √°rboles y flores) -->
                <div id="garden-grid" class="flex-1 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-4 content-start overflow-y-auto z-0 p-2 pb-20">
                    <!-- Las plantas se inyectar√°n aqu√≠ -->
                </div>
                
                <!-- Decoraci√≥n de fondo (suelo) -->
                <div id="ground-gradient" class="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-green-200 to-transparent z-0 pointer-events-none opacity-50"></div>
            </div>
        </div>
    </div>

    <footer class="mt-6 mb-6 px-3 py-1 text-center text-xs font-semibold text-gray-700 dark:text-gray-300">
        Feito com üíô pelo <a href="https://instagram.com/aleqcodes" target="_blank" rel="noopener noreferrer" class="underline hover:text-green-600 dark:hover:text-green-400">@aleqcodes</a> ‚Ä¢ GitHub: <a href="https://github.com/aleqcodes" target="_blank" rel="noopener noreferrer" class="underline hover:text-green-600 dark:hover:text-green-400">@aleqcodes</a>
    </footer>

    <script>
        // --- Configuraci√≥n y Estado ---
        const MODES = {
            focus: { time: 25 * 60, color: 'text-green-500', label: 'Enfoque', reward: 'tree' },
            short: { time: 5 * 60, color: 'text-teal-500', label: 'Descanso Corto', reward: 'flower' },
            long: { time: 15 * 60, color: 'text-indigo-500', label: 'Descanso Largo', reward: 'butterfly' }
        };

        const ASSETS = {
            tree: ['üå≥', 'üå¥'],
            flower: ['üåª', 'üåπ', 'üå∑', 'üå∫', 'üå∏', 'üåº', 'ü™∑'],
            butterfly: ['ü¶ã']
        };

        const FRUITS_GENERAL = ['üçé','üçã','üçä','üçë','üçê','üçÖ','üçí','üçá','ü•≠','üçì'];
        const FRUITS_PALM = ['ü••'];

        let timeLeft = MODES.focus.time;
        let currentMode = 'focus';
        let timerId = null;
        let isRunning = false;
        let startTs = null;
        let endTs = null;
        let spinnerRAF = null;
        let spinnerOffset = 0;
        let spinnerCirc = 0;
        
        // Cargar estado inicial del jard√≠n o crear vac√≠o
        let gardenState = JSON.parse(localStorage.getItem('pomodoroGarden')) || [];

        // Elementos DOM
        const timerDisplay = document.getElementById('timer-display');
        const statusText = document.getElementById('status-text');
        const playBtn = document.getElementById('toggle-btn');
        const iconPlay = document.getElementById('icon-play');
        const textPlay = document.getElementById('text-play');
        const progressRing = document.getElementById('progress-ring');
        const spinnerRing = document.getElementById('spinner-ring');
        const gardenGrid = document.getElementById('garden-grid');
        const skyLayer = document.getElementById('sky-layer');
        const plantCountEl = document.getElementById('plant-count');
        const butterflyCountEl = document.getElementById('butterfly-count');
        const alarmSound = document.getElementById('alarm-sound');
        const langBtnEs = document.getElementById('lang-es');
        const langBtnPt = document.getElementById('lang-pt');
        const langBtnEn = document.getElementById('lang-en');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const titleEl = document.getElementById('app-title');
        const subtitleEl = document.getElementById('app-subtitle');
        const legendTitleEl = document.getElementById('legend-title');
        const legendTreeEl = document.getElementById('legend-tree');
        const legendFlowerEl = document.getElementById('legend-flower');
        const legendButterflyEl = document.getElementById('legend-butterfly');
        const gardenTitleEl = document.getElementById('garden-title');
        const resetBtnEl = document.getElementById('reset-btn');
        const plantLabelEl = document.getElementById('plant-label');
        const butterflyLabelEl = document.getElementById('butterfly-label');

        const I18N = {
            es: {
                title: 'üçÖ Jard√≠n Pomodoro',
                subtitle: 'Conc√©ntrate y cultiva tu bosque',
                mode_focus: 'Enfoque',
                mode_short: 'Descanso Corto',
                mode_long: 'Descanso Largo',
                status_ready: 'Listo para cultivar',
                status_growing: 'Creciendo...',
                status_paused: 'En pausa',
                btn_start: 'Comenzar',
                btn_pause: 'Pausar',
                btn_resume: 'Continuar',
                legend_title: 'Tu Recompensa:',
                legend_tree: '25 min = √Årbol Frutal',
                legend_flower: '5 min = Flor',
                legend_butterfly: '15 min = Mariposa (Vuela)',
                garden_title: 'Tu Jard√≠n',
                reset_btn: 'Reiniciar Jard√≠n (Borrar todo)',
                clear_confirm: '¬øEst√°s seguro de que quieres talar todo tu bosque? Esta acci√≥n no se puede deshacer.',
                mode_change_confirm: 'El temporizador est√° corriendo. ¬øQuieres detenerlo y cambiar de modo?',
                alert_tree: '¬°Tiempo completado! Has cultivado: Un √Årbol',
                alert_flower: '¬°Tiempo completado! Has cultivado: Una Flor',
                alert_butterfly: '¬°Tiempo completado! Has cultivado: Una Mariposa',
                doc_label_focus: 'Enfoque',
                doc_label_short: 'Descanso Corto',
                doc_label_long: 'Descanso Largo',
                plants_label: 'Plantas',
                butterflies_label: 'Mariposas',
                toggle_to_dark: 'üåö Oscuro',
                toggle_to_light: 'üåû Claro',
                name_prompt: 'Nombre del √°rbol:'
            },
            pt: {
                title: 'üçÖ Jardim Pomodoro',
                subtitle: 'Concentre-se e cultive sua floresta',
                mode_focus: 'Foco',
                mode_short: 'Pausa Curta',
                mode_long: 'Pausa Longa',
                status_ready: 'Pronto para cultivar',
                status_growing: 'Crescendo...',
                status_paused: 'Pausado',
                btn_start: 'Come√ßar',
                btn_pause: 'Pausar',
                btn_resume: 'Continuar',
                legend_title: 'Sua Recompensa:',
                legend_tree: '25 min = √Årvore Frut√≠fera',
                legend_flower: '5 min = Flor',
                legend_butterfly: '15 min = Borboleta (Voa)',
                garden_title: 'Seu Jardim',
                reset_btn: 'Reiniciar Jardim (Apagar tudo)',
                clear_confirm: 'Tem certeza que deseja derrubar todo o bosque? Esta a√ß√£o n√£o pode ser desfeita.',
                mode_change_confirm: 'O temporizador est√° em execu√ß√£o. Deseja parar e trocar o modo?',
                alert_tree: 'Tempo conclu√≠do! Voc√™ cultivou: Uma √Årvore',
                alert_flower: 'Tempo conclu√≠do! Voc√™ cultivou: Uma Flor',
                alert_butterfly: 'Tempo conclu√≠do! Voc√™ cultivou: Uma Borboleta',
                doc_label_focus: 'Foco',
                doc_label_short: 'Pausa Curta',
                doc_label_long: 'Pausa Longa',
                plants_label: 'Plantas',
                butterflies_label: 'Borboletas',
                toggle_to_dark: 'üåö Escuro',
                toggle_to_light: 'üåû Claro',
                name_prompt: 'Nome da √°rvore:'
            },
            en: {
                title: 'üçÖ Pomodoro Garden',
                subtitle: 'Focus and grow your forest',
                mode_focus: 'Focus',
                mode_short: 'Short Break',
                mode_long: 'Long Break',
                status_ready: 'Ready to grow',
                status_growing: 'Growing...',
                status_paused: 'Paused',
                btn_start: 'Start',
                btn_pause: 'Pause',
                btn_resume: 'Resume',
                legend_title: 'Your Reward:',
                legend_tree: '25 min = Fruit Tree',
                legend_flower: '5 min = Flower',
                legend_butterfly: '15 min = Butterfly (Flies)',
                garden_title: 'Your Garden',
                reset_btn: 'Reset Garden (Erase all)',
                clear_confirm: 'Are you sure you want to clear the forest? This action cannot be undone.',
                mode_change_confirm: 'The timer is running. Do you want to stop and change mode?',
                alert_tree: 'Time complete! You cultivated: A Tree',
                alert_flower: 'Time complete! You cultivated: A Flower',
                alert_butterfly: 'Time complete! You cultivated: A Butterfly',
                doc_label_focus: 'Focus',
                doc_label_short: 'Short Break',
                doc_label_long: 'Long Break',
                plants_label: 'Plants',
                butterflies_label: 'Butterflies',
                toggle_to_dark: 'üåö Dark',
                toggle_to_light: 'üåû Light',
                name_prompt: 'Tree name:'
            }
        };

        let currentLang = localStorage.getItem('pomodoroLang') || 'es';

        function t(key) {
            const dict = I18N[currentLang] || I18N.es;
            return dict[key] || key;
        }

        function updateLangButtons() {
            [langBtnEs, langBtnPt, langBtnEn].forEach(btn => { if (btn) btn.classList.remove('opacity-100','ring-1','ring-gray-300'); });
            const map = { es: langBtnEs, pt: langBtnPt, en: langBtnEn };
            const active = map[currentLang];
            if (active) { active.classList.add('opacity-100','ring-1','ring-gray-300'); }
        }

        function applyLanguage() {
            if (titleEl) titleEl.textContent = t('title');
            if (subtitleEl) subtitleEl.textContent = t('subtitle');
            const bf = document.getElementById('btn-focus');
            const bs = document.getElementById('btn-short');
            const bl = document.getElementById('btn-long');
            if (bf) bf.textContent = t('mode_focus');
            if (bs) bs.textContent = t('mode_short');
            if (bl) bl.textContent = t('mode_long');
            if (legendTitleEl) legendTitleEl.textContent = t('legend_title');
            if (legendTreeEl) legendTreeEl.innerHTML = '<span class="text-xl">üçé/üçã</span> ' + t('legend_tree');
            if (legendFlowerEl) legendFlowerEl.innerHTML = '<span class="text-xl">üåª/üåπ</span> ' + t('legend_flower');
            if (legendButterflyEl) legendButterflyEl.innerHTML = '<span class="text-xl">ü¶ã</span> ' + t('legend_butterfly');
            if (gardenTitleEl) gardenTitleEl.textContent = t('garden_title');
            if (resetBtnEl) resetBtnEl.textContent = t('reset_btn');
            if (plantLabelEl) plantLabelEl.textContent = t('plants_label');
            if (butterflyLabelEl) butterflyLabelEl.textContent = t('butterflies_label');
            const totalTime = MODES[currentMode].time;
            const paused = !isRunning && timeLeft > 0 && timeLeft < totalTime;
            if (statusText) statusText.textContent = isRunning ? t('status_growing') : paused ? t('status_paused') : t('status_ready');
            if (textPlay) textPlay.textContent = isRunning ? t('btn_pause') : paused ? t('btn_resume') : t('btn_start');
            updateStatusColor();
            updateThemeButtonLabel();
            updateLangButtons();
            updateDisplay();
            
        }

        function updateStatusColor() {
            const base = MODES[currentMode].color;
            if (statusText) statusText.className = `font-medium mt-2 ${base} dark:${base}`;
        }

        function updateThemeButtonLabel() {
            const isDark = document.documentElement.classList.contains('dark');
            if (themeToggleBtn) themeToggleBtn.textContent = isDark ? t('toggle_to_light') : t('toggle_to_dark');
        }

        function setTheme(theme) {
            if (theme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            try { localStorage.setItem('pomodoroTheme', theme); } catch(e) {}
            updateThemeButtonLabel();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            setTheme(isDark ? 'light' : 'dark');
        }

        function setLang(lang) {
            currentLang = lang;
            try { localStorage.setItem('pomodoroLang', lang); } catch(e) {}
            applyLanguage();
        }

        function getGridColumnCount() {
            const styles = window.getComputedStyle(gardenGrid);
            const cols = styles.gridTemplateColumns.split(' ').filter(Boolean).length;
            return Math.max(cols, 1);
        }

        function cellKey(c, r) { return `${c}-${r}`; }

        function findFreeCell(cols, used) {
            const usedRows = Array.from(used).map(k => parseInt(k.split('-')[1], 10));
            const maxRow = usedRows.length ? Math.max(...usedRows) : 0;
            for (let attempt = 0; attempt < 200; attempt++) {
                const col = 1 + Math.floor(Math.random() * cols);
                const row = 1 + Math.floor(Math.random() * (maxRow + 3));
                const key = cellKey(col, row);
                if (!used.has(key)) return { col, row };
            }
            for (let row = 1; row < maxRow + 100; row++) {
                for (let col = 1; col <= cols; col++) {
                    const key = cellKey(col, row);
                    if (!used.has(key)) return { col, row };
                }
            }
            return { col: 1, row: maxRow + 1 };
        }

        function ensureGroundPosition(item, used, cols) {
            if (!item.col || !item.row) {
                const pos = findFreeCell(cols, used);
                item.col = pos.col;
                item.row = pos.row;
                saveGarden();
            }
            const k = cellKey(item.col, item.row);
            if (used.has(k)) {
                const pos = findFreeCell(cols, used);
                item.col = pos.col;
                item.row = pos.row;
                saveGarden();
            }
            used.add(cellKey(item.col, item.row));
        }

        function skyGridConfig() {
            const rect = skyLayer.getBoundingClientRect();
            const cols = Math.max(Math.floor(rect.width / 80), 6);
            const rows = Math.max(Math.floor(rect.height / 80), 4);
            return { cols, rows };
        }

        function findFreeSkyCell(used, cfg) {
            for (let attempt = 0; attempt < 200; attempt++) {
                const col = 1 + Math.floor(Math.random() * cfg.cols);
                const row = 1 + Math.floor(Math.random() * cfg.rows);
                const key = cellKey(col, row);
                if (!used.has(key)) return { col, row };
            }
            return { col: 1, row: 1 };
        }

        function skyCellToPercent(col, row, cfg) {
            const left = ((col - 0.5) / cfg.cols) * 100;
            const top = ((row - 0.5) / cfg.rows) * 100;
            return { left, top };
        }

        
        
        const radius = progressRing.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        progressRing.style.strokeDashoffset = circumference;
        if (spinnerRing) {
            const sRadius = spinnerRing.r.baseVal.value;
            spinnerCirc = sRadius * 2 * Math.PI;
            const seg = Math.max(80, Math.min(220, Math.round(spinnerCirc * 0.25)));
            spinnerRing.style.setProperty('stroke-dasharray', `${seg} ${spinnerCirc - seg}`);
            spinnerRing.style.setProperty('stroke-dashoffset', '0');
        }
        
        applyLanguage();

        function startSpinner() {
            if (!spinnerRing || spinnerRAF) return;
            spinnerOffset = 0;
            let last = performance.now();
            const speed = 400; // units per second
            const loop = (ts) => {
                const dt = ts - last;
                last = ts;
                spinnerOffset = (spinnerOffset + (dt / 1000) * speed) % spinnerCirc;
                spinnerRing.style.strokeDashoffset = -spinnerOffset;
                spinnerRAF = requestAnimationFrame(loop);
            };
            spinnerRAF = requestAnimationFrame(loop);
        }

        function stopSpinner() {
            if (spinnerRAF) {
                cancelAnimationFrame(spinnerRAF);
                spinnerRAF = null;
            }
            if (spinnerRing) spinnerRing.style.strokeDashoffset = 0;
        }

        // --- Funciones Principales ---

        function setProgress(percent) {
            const offset = circumference - (percent / 100) * circumference;
            progressRing.style.strokeDashoffset = offset;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
            const totalTime = MODES[currentMode].time;
            const percent = ((totalTime - timeLeft) / totalTime) * 100;
            setProgress(percent);
            document.title = `${formatTime(timeLeft)} - ${t('doc_label_' + currentMode)}`;
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (isRunning) return;
            if (timeLeft <= 0) timeLeft = MODES[currentMode].time;
            isRunning = true;
            playBtn.classList.replace('bg-green-500', 'bg-yellow-500');
            playBtn.classList.replace('hover:bg-green-600', 'hover:bg-yellow-600');
            iconPlay.textContent = '‚è∏';
            textPlay.textContent = t('btn_pause');
            statusText.textContent = t('status_growing');
            startSpinner();
            startTs = Date.now();
            endTs = startTs + timeLeft * 1000;
            timerId = setInterval(() => {
                const remain = Math.max(0, Math.floor((endTs - Date.now()) / 1000));
                if (remain !== timeLeft) {
                    timeLeft = remain;
                    updateDisplay();
                }
                if (remain <= 0) {
                    completeCycle();
                }
            }, 250);
        }

        function pauseTimer() {
            clearInterval(timerId);
            timerId = null;
            isRunning = false;
            playBtn.classList.replace('bg-yellow-500', 'bg-green-500');
            playBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-green-600');
            iconPlay.textContent = '‚ñ∂';
            textPlay.textContent = t('btn_resume');
            statusText.textContent = t('status_paused');
            stopSpinner();
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = MODES[currentMode].time;
            updateDisplay();
            statusText.textContent = t('status_ready');
            setProgress(0);
            textPlay.textContent = t('btn_start');
            stopSpinner();
        }

        function setMode(mode) {
            if (isRunning) {
                const confirmChange = confirm(t('mode_change_confirm'));
                if (!confirmChange) return;
            }
            
            pauseTimer();
            currentMode = mode;
            timeLeft = MODES[mode].time;
            
            // Actualizar botones activos
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.className = 'flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-all text-gray-500 hover:text-green-600 dark:text-gray-400';
            });
            const activeBtn = document.getElementById(`btn-${mode}`);
            activeBtn.className = 'flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-all bg-white shadow-sm text-green-600 border border-green-100 dark:bg-gray-900 dark:text-green-400 dark:border dark:border-green-900';

            // Cambiar color del anillo
            progressRing.setAttribute('class', `progress-ring__circle ${MODES[mode].color}`);
            updateStatusColor();

            resetTimer();
        }

        function completeCycle() {
            pauseTimer();
            timeLeft = 0;
            updateDisplay();
            try { alarmSound.play(); } catch(e) {}
            const rewardType = MODES[currentMode].reward;
            addRewardToGarden(rewardType);
            alert(rewardType === 'tree' ? t('alert_tree') : rewardType === 'flower' ? t('alert_flower') : t('alert_butterfly'));
            textPlay.textContent = t('btn_start');
            statusText.textContent = t('status_ready');
            stopSpinner();
        }

        // --- L√≥gica del Jard√≠n ---

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function addRewardToGarden(type) {
            const item = {
                type: type,
                emoji: getRandomItem(ASSETS[type]),
                id: Date.now(),
                delay: Math.random() * 1.2
            };
            gardenState.push(item);
            saveGarden();
            renderGarden();
        }

        function saveGarden() {
            localStorage.setItem('pomodoroGarden', JSON.stringify(gardenState));
        }

        function renderGarden() {
            gardenGrid.innerHTML = '';
            skyLayer.innerHTML = '';

            const cols = getGridColumnCount();
            const used = new Set();

            let plants = 0;
            let butterflies = 0;

            const skyUsed = new Set();
            const cfg = skyGridConfig();

            gardenState.forEach(item => {
                if (item.type === 'butterfly') {
                    butterflies++;
                } else {
                    plants++;
                }
            });

            plantCountEl.textContent = plants;
            butterflyCountEl.textContent = butterflies;

            gardenState.forEach(item => {
                if (item.type === 'butterfly') {
                    if (item.left == null || item.top == null) {
                        const cell = findFreeSkyCell(skyUsed, cfg);
                        skyUsed.add(cellKey(cell.col, cell.row));
                        const pct = skyCellToPercent(cell.col, cell.row, cfg);
                        item.left = pct.left;
                        item.top = pct.top;
                        saveGarden();
                    } else {
                        const col = Math.max(1, Math.min(cfg.cols, Math.round((item.left / 100) * cfg.cols)));
                        const row = Math.max(1, Math.min(cfg.rows, Math.round((item.top / 100) * cfg.rows)));
                        skyUsed.add(cellKey(col, row));
                    }
                    const el = document.createElement('div');
                    el.className = 'butterfly';
                    el.textContent = item.emoji;
                    el.style.left = item.left + '%';
                    el.style.top = item.top + '%';
                    el.style.animationDelay = (item.delay || 0) + 's';
                    skyLayer.appendChild(el);
                } else {
                    ensureGroundPosition(item, used, cols);
                    let el;
                    if (item.type === 'tree') {
                        el = createTreeElement(item);
                    } else {
                        el = createFlowerElement(item);
                    }
                    el.style.gridColumnStart = item.col;
                    el.style.gridRowStart = item.row;
                    gardenGrid.appendChild(el);
                }
            });

            if (plants > 0) {
                gardenGrid.scrollTop = gardenGrid.scrollHeight;
            }
        }

        function createTreeElement(item) {
            const el = document.createElement('div');
            el.className = 'garden-item plant-item flex justify-center items-center h-20 w-20 bg-white/30 rounded-xl shadow-sm backdrop-blur-sm dark:bg-white/5';
            const trunk = document.createElement('span');
            trunk.textContent = item.emoji || getRandomItem(ASSETS.tree);
            trunk.style.fontSize = '2rem';
            el.appendChild(trunk);

            const trunkEmoji = trunk.textContent;
            const isPalm = trunkEmoji === 'üå¥';

            const invalidForType = () => {
                if (!item.fruits) return true;
                const distinct = new Set(item.fruits);
                if (distinct.size > 1) return true;
                if (isPalm) return item.fruits.some(f => f !== 'ü••');
                return item.fruits.some(f => f === 'ü••');
            };

            if (!item.fruits || !item.fruitPositions || item.fruits.length !== item.fruitPositions.length || invalidForType()) {
                const count = 3 + Math.floor(Math.random() * 3);
                const pool = isPalm ? FRUITS_PALM : FRUITS_GENERAL;
                const fruitType = getRandomItem(pool);
                item.fruits = Array.from({ length: count }, () => fruitType);
                item.fruitPositions = Array.from({ length: count }, () => ({ left: 15 + Math.random() * 70, top: 10 + Math.random() * 55 }));
                saveGarden();
            }

            item.fruits.forEach((fruit, i) => {
                const f = document.createElement('span');
                f.textContent = fruit;
                f.style.position = 'absolute';
                f.style.left = item.fruitPositions[i].left + '%';
                f.style.top = item.fruitPositions[i].top + '%';
                f.style.fontSize = '1rem';
                el.appendChild(f);
            });

            if (item.name) {
                const nameEl = document.createElement('div');
                nameEl.textContent = item.name;
                nameEl.className = 'absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] font-semibold px-2 py-0.5 rounded-full bg-white/50 dark:bg-white/10';
                el.appendChild(nameEl);
            }

            el.addEventListener('click', () => {
                const name = prompt(t('name_prompt'), item.name || '');
                if (name !== null) {
                    item.name = name.trim();
                    saveGarden();
                    renderGarden();
                }
            });

            el.style.animationDelay = (item.delay || Math.random() * 0.8) + 's';
            return el;
        }

        function createFlowerElement(item) {
            const el = document.createElement('div');
            el.className = 'garden-item plant-item flex justify-center items-center h-16 w-16 bg-white/30 rounded-xl shadow-sm backdrop-blur-sm dark:bg-white/5';
            const s = document.createElement('span');
            s.textContent = item.emoji;
            s.style.fontSize = '1.5rem';
            el.appendChild(s);
            el.style.animationDelay = (item.delay || Math.random() * 0.8) + 's';
            return el;
        }

        function clearGarden() {
            if(confirm(t('clear_confirm'))) {
                gardenState = [];
                saveGarden();
                renderGarden();
            }
        }

        // Inicializaci√≥n
        setMode('focus'); // Default
        renderGarden(); // Cargar jard√≠n guardado
        
        // Solicitar permiso notificaciones (Opcional, no cr√≠tico)
        if ("Notification" in window) {
            Notification.requestPermission();
        }

    </script>
</body>
</html>
